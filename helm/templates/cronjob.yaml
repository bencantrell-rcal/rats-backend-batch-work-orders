apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-cron
  labels:
    app: {{ .Release.Name }}
spec:
  schedule: {{ .Values.cron.schedule | quote }}
  concurrencyPolicy: {{ .Values.cron.concurrencyPolicy }}
  successfulJobsHistoryLimit: {{ .Values.cron.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ .Values.cron.failedJobsHistoryLimit }}
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            redeploy-timestamp: {{ .Values.redeployTimestamp | quote }}
        spec:
          serviceAccountName: cloudsql-app-ksa
          restartPolicy: OnFailure
          shareProcessNamespace: true
          containers:
            - name: {{ .Release.Name }}-cron
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              resources:
                {{- toYaml .Values.resources | nindent 16 }}
              args:
                {{- toYaml .Values.cron.args | nindent 16 }}
              envFrom:
                - configMapRef:
                    name: {{ .Release.Name }}-config
              env:
                - name: MAIN_CONTAINER
                  value: "true"

            {{- if .Values.cloudsql.enabled }}
            - name: cloud-sql-proxy
              image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.18.2
              args:
                - "--structured-logs"
                - "--port=3306"
                - "--address=0.0.0.0"
                - "--private-ip"
                - "--exit-zero-on-sigterm"
                - "{{ .Values.cloudsql.instanceConnectionName }}"
              securityContext:
                runAsNonRoot: true

            - name: proxy-killer
              image: busybox:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  echo "Waiting for main container to complete..."
                  # Find the PID of the main container by looking for the env var
                  while true; do
                    MAIN_PID=$(ps aux | grep -v grep | awk '{print $1}' | while read pid; do
                      if [ -f "/proc/$pid/environ" ] && grep -q "MAIN_CONTAINER=true" "/proc/$pid/environ" 2>/dev/null; then
                        echo $pid
                        break
                      fi
                    done)

                    if [ -n "$MAIN_PID" ]; then
                      echo "Found main container PID: $MAIN_PID, monitoring..."
                      # Wait for this PID to disappear
                      while kill -0 $MAIN_PID 2>/dev/null; do
                        sleep 2
                      done
                      echo "Main container exited, waiting 5 seconds..."
                      sleep 5
                      echo "Killing cloud-sql-proxy..."
                      pkill -TERM cloud-sql-proxy
                      exit 0
                    fi
                    sleep 2
                  done
              securityContext:
                runAsNonRoot: false
            {{- end }}