apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-cron
  labels:
    app: {{ .Release.Name }}
spec:
  schedule: {{ .Values.cron.schedule | quote }}
  concurrencyPolicy: {{ .Values.cron.concurrencyPolicy }}
  successfulJobsHistoryLimit: {{ .Values.cron.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ .Values.cron.failedJobsHistoryLimit }}
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            redeploy-timestamp: {{ .Values.redeployTimestamp | quote }}
        spec:
          serviceAccountName: cloudsql-app-ksa
          restartPolicy: OnFailure
          shareProcessNamespace: true
          containers:
            - name: {{ .Release.Name }}-cron
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              resources:
                {{- toYaml .Values.resources | nindent 16 }}
              args:
                {{- toYaml .Values.cron.args | nindent 16 }}
              envFrom:
                - configMapRef:
                    name: {{ .Release.Name }}-config

            {{- if .Values.cloudsql.enabled }}
            - name: cloud-sql-proxy
              image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.18.2
              args:
                - "--structured-logs"
                - "--port=3306"
                - "--address=0.0.0.0"
                - "--private-ip"
                - "{{ .Values.cloudsql.instanceConnectionName }}"
              securityContext:
                runAsNonRoot: true

            - name: proxy-killer
              image: busybox:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  # Wait for main container to finish
                  while ps aux | grep -v grep | grep -q "{{ .Release.Name }}-cron"; do
                    sleep 2
                  done
                  # Kill the proxy
                  killall cloud-sql-proxy
                  # Exit so this container also terminates
                  exit 0
              securityContext:
                runAsNonRoot: false
            {{- end }}