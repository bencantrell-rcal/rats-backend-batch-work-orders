apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-cron
  labels:
    app: {{ .Release.Name }}
spec:
  schedule: {{ .Values.cron.schedule | quote }}
  concurrencyPolicy: {{ .Values.cron.concurrencyPolicy }}
  successfulJobsHistoryLimit: {{ .Values.cron.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ .Values.cron.failedJobsHistoryLimit }}
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            redeploy-timestamp: {{ .Values.redeployTimestamp | quote }}
        spec:
          serviceAccountName: cloudsql-app-ksa
          restartPolicy: OnFailure
          shareProcessNamespace: true
          containers:
            - name: {{ .Release.Name }}-cron
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              resources:
                {{- toYaml .Values.resources | nindent 16 }}
              args:
                {{- toYaml .Values.cron.args | nindent 16 }}
              envFrom:
                - configMapRef:
                    name: {{ .Release.Name }}-config

            {{- if .Values.cloudsql.enabled }}
            - name: cloud-sql-proxy
              image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.18.2
              args:
                - "--structured-logs"
                - "--port=3306"
                - "--address=0.0.0.0"
                - "--private-ip"
                - "--exit-zero-on-sigterm"
                - "{{ .Values.cloudsql.instanceConnectionName }}"
              securityContext:
                runAsNonRoot: true

            - name: proxy-killer
              image: busybox:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  echo "Waiting for main container to complete..."
                  # Loop until the main container's process is gone
                  while true; do
                    # Check /proc to see if container processes exist (PIDs will disappear when container exits)
                    # Look for processes that aren't sh, cloud-sql-proxy, or pause
                    MAIN_RUNNING=$(ps -ef | grep -v "grep" | grep -v "sh -c" | grep -v "cloud-sql-proxy" | grep -v "/pause" | grep -v "ps -ef" | tail -n +2 | wc -l)

                    if [ "$MAIN_RUNNING" -eq 0 ]; then
                      echo "Main container has exited, waiting 5 seconds..."
                      sleep 5
                      echo "Killing cloud-sql-proxy..."
                      pkill -TERM cloud-sql-proxy
                      exit 0
                    fi
                    sleep 2
                  done
              securityContext:
                runAsNonRoot: false
            {{- end }}